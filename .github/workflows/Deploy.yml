name: Deploy Application
on:
  workflow_call:
    inputs:
      app_name:
        description: 'Name of the application'
        required: true
        type: string
      working-directory: 
        description: 'Name of the workflow to trigger after build'
        required: false
        type: string

    secrets: # Ù„Ø§Ø²Ù… ØªØ¹Ø±ÙÙ‡Ù… Ù‡Ù†Ø§ Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ Workflow ÙŠØ´ÙˆÙÙ‡Ù…
      IP_MASTER:
        required: true
      SSH_PASSWORD:
        required: true
      SSH_USER:
        required: false
      
jobs:
  deploy:
    runs-on: ubuntu-latest

    
    steps:
      

      - name: Checkout DevOps Repo (Docker Compose)
        uses: actions/checkout@v3
        

      - name: Install SSH Password Tool
        run: |
          echo "ğŸ”§ Installing sshpass for password authentication..."
          sudo apt-get update
          sudo apt-get install -y sshpass
          echo "âœ… sshpass installed successfully"

      - name: Setup SSH Configuration
        run: |
          if [ -z "${{ secrets.IP_MASTER }}" ]; then
            echo "âŒ Missing IP_MASTER secret"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PASSWORD }}" ]; then
            echo "âŒ Missing SSH_PASSWORD secret"
            exit 1
          fi
          
          # Set default user to root if SSH_USER not provided
          SSH_USER="${{ secrets.SSH_USER }}"
          if [ -z "$SSH_USER" ]; then
            SSH_USER="root"
          fi
          echo "SSH_USER=$SSH_USER" >> $GITHUB_ENV
          
          echo "ğŸ”§ Setting up SSH configuration..."
          echo "ğŸ“ Target server: ${{ secrets.IP_MASTER }}"
          echo "ğŸ‘¤ SSH User: $SSH_USER"
          echo "ğŸ” Using password authentication"
          
          mkdir -p ~/.ssh
          touch ~/.ssh/known_hosts
          echo "ğŸ” Scanning host keys..."
          ssh-keyscan -T 10 -H ${{ secrets.IP_MASTER }} >> ~/.ssh/known_hosts || echo "âš ï¸ Host key scan failed, will use StrictHostKeyChecking=no"

      - name: Check Server Connectivity
        timeout-minutes: 2
        run: |
          echo "ğŸŒ Testing basic connectivity to ${{ secrets.IP_MASTER }}..."
          # Test if server responds to ping
          if ping -c 3 ${{ secrets.IP_MASTER }} > /dev/null 2>&1; then
            echo "âœ… Server is reachable via ping"
          else
            echo "âŒ Server is not responding to ping"
            echo "ğŸ’¡ This might be normal if ICMP is disabled"
          fi
          
          # Test if SSH port is open
          echo "ğŸ” Testing SSH port (22) connectivity..."
          if timeout 10 bash -c "</dev/tcp/${{ secrets.IP_MASTER }}/22"; then
            echo "âœ… SSH port 22 is open"
          else
            echo "âŒ SSH port 22 is not accessible"
            echo "ğŸ’¡ Please ensure:"
            echo "   - SSH service is running on the server"
            echo "   - Port 22 is open in firewall"
            echo "   - Server IP address is correct"
            exit 1
          fi

      - name: Test SSH Connection
        timeout-minutes: 2
        run: |
          echo "ğŸ” Testing SSH password authentication..."
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ“¡ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Connecting to $SSH_USER@${{ secrets.IP_MASTER }}..."
            
            if sshpass -p '${{ secrets.SSH_PASSWORD }}' ssh -o StrictHostKeyChecking=no -o ConnectTimeout=15 $SSH_USER@${{ secrets.IP_MASTER }} 'echo "âœ… SSH connection successful!" && whoami && pwd'; then
              echo "ğŸ‰ SSH password authentication successful!"
              break
            else
              echo "âŒ SSH connection failed"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "â³ Waiting 10 seconds before retry..."
                sleep 10
              fi
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "ğŸ’¥ Failed to establish SSH connection after $MAX_RETRIES attempts"
            echo "ğŸ” Troubleshooting for password authentication:"
            echo "   1. âœ… Verify the password is correct"
            echo "   2. âœ… Check if password authentication is enabled on server:"
            echo "      - Edit: sudo nano /etc/ssh/sshd_config"
            echo "      - Set: PasswordAuthentication yes"
            echo "      - Set: PermitRootLogin yes (if using root)"
            echo "      - Restart: sudo systemctl restart ssh"
            echo "   3. âœ… Ensure user exists on server: cat /etc/passwd | grep $SSH_USER"
            echo "   4. âœ… Check server SSH logs: sudo tail -f /var/log/auth.log"
            exit 1
          fi

      - name: move the config file to the server
        run: |
          
          TARGET_DIR="/root"
          
          if sshpass -p '${{ secrets.SSH_PASSWORD }}' scp -o StrictHostKeyChecking=no ${{ inputs.working-directory }}/nginx/nginx.conf $SSH_USER@${{ secrets.IP_MASTER }}:$TARGET_DIR/nginx/nginx.conf; then
            echo "âœ… Configuration file copied successfully to $TARGET_DIR"
          else
            echo "âŒ Failed to copy configuration file"
            exit 1
          fi

      - name: Deploy Docker Compose File
        run: |
          

          TARGET_DIR="/root"
          
          if sshpass -p '${{ secrets.SSH_PASSWORD }}' scp -o StrictHostKeyChecking=no ${{ inputs.working-directory }}/docker-compose.yml $SSH_USER@${{ secrets.IP_MASTER }}:$TARGET_DIR/docker-compose.yml; then
            echo "âœ… Docker Compose file copied successfully to $TARGET_DIR"
          else
            echo "âŒ Failed to copy Docker Compose file"
            exit 1
          fi
          

      - name: Deploy and Refresh Application
        run: |
          echo "ğŸš€ Refreshing and Deploying application..."
          TARGET_DIR="/root"
          
          sshpass -p '${{ secrets.SSH_PASSWORD }}' ssh -o StrictHostKeyChecking=no $SSH_USER@${{ secrets.IP_MASTER }} "
            cd $TARGET_DIR && \
            # 1. Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø£ÙˆÙ„Ø§Ù‹
            docker compose pull && \
            # 2. Ø­Ø°Ù Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª ÙˆØ§Ù„Ù€ Volume Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ÙØ±ÙˆÙ†Øª ØªØ­Ø¯ÙŠØ¯Ø§Ù‹
            # Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ -v Ù…Ø¹ down Ù„Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù€ Volumes Ø£Ùˆ Ø§Ù…Ø³Ø­ Ø§Ù„ÙÙˆÙ„ÙŠÙˆÙ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙŠØ¯ÙˆÙŠØ§Ù‹
            docker compose down && \
            docker volume rm frontend-files || true && \
            # 3. Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ù† Ø¬Ø¯ÙŠØ¯
            docker compose up -d
          "


        

      
        

  
        
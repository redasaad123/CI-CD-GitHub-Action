name: Deploy Application
on:
  workflow_call:
    inputs:
      app_name:
        description: 'Name of the application'
        required: true
        type: string

    secrets: # Ù„Ø§Ø²Ù… ØªØ¹Ø±ÙÙ‡Ù… Ù‡Ù†Ø§ Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ Workflow ÙŠØ´ÙˆÙÙ‡Ù…
      IP_MASTER:
        required: true
      PRIVATE_KEY:
        required: true
      
jobs:
  deploy:
    runs-on: ubuntu-latest

    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH Key
        run: |
          if [ -z "${{ secrets.IP_MASTER }}" ]; then
            echo "âŒ Missing IP_MASTER secret"
            exit 1
          fi
          if [ -z "${{ secrets.PRIVATE_KEY }}" ]; then
            echo "âŒ Missing PRIVATE_KEY secret"
            exit 1
          fi
          echo "ğŸ”§ Setting up SSH configuration..."
          echo "ğŸ“ Target server: ${{ secrets.IP_MASTER }}"
          mkdir -p ~/.ssh
          touch ~/.ssh/known_hosts
          echo "${{ secrets.PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "ğŸ” Scanning host keys..."
          ssh-keyscan -T 10 -H ${{ secrets.IP_MASTER }} >> ~/.ssh/known_hosts || echo "âš ï¸ Host key scan failed, will use StrictHostKeyChecking=no"

      - name: Check Server Connectivity
        timeout-minutes: 2
        run: |
          echo "ğŸŒ Testing basic connectivity to ${{ secrets.IP_MASTER }}..."
          # Test if server responds to ping
          if ping -c 3 ${{ secrets.IP_MASTER }} > /dev/null 2>&1; then
            echo "âœ… Server is reachable via ping"
          else
            echo "âŒ Server is not responding to ping"
            echo "ğŸ’¡ This might be normal if ICMP is disabled"
          fi
          
          # Test if SSH port is open
          echo "ğŸ” Testing SSH port (22) connectivity..."
          if timeout 10 bash -c "</dev/tcp/${{ secrets.IP_MASTER }}/22"; then
            echo "âœ… SSH port 22 is open"
          else
            echo "âŒ SSH port 22 is not accessible"
            echo "ğŸ’¡ Please ensure:"
            echo "   - SSH service is running on the server"
            echo "   - Port 22 is open in firewall"
            echo "   - Server IP address is correct"
            exit 1
          fi

      - name: Test SSH Connection
        timeout-minutes: 1
        run: |
          echo "ğŸ” Testing SSH authentication..."
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ“¡ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Connecting to root@${{ secrets.IP_MASTER }}..."
            
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes root@${{ secrets.IP_MASTER }} 'echo "âœ… SSH connection successful!" && whoami && pwd'; then
              echo "ğŸ‰ SSH authentication successful!"
              break
            else
              echo "âŒ SSH connection failed"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "â³ Waiting 10 seconds before retry..."
                sleep 10
              fi
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "ğŸ’¥ Failed to establish SSH connection after $MAX_RETRIES attempts"
            echo "ğŸ” Troubleshooting tips:"
            echo "   1. Verify the private key is correct"
            echo "   2. Check if the key matches the public key on the server"
            echo "   3. Ensure root login is allowed (PermitRootLogin yes)"
            echo "   4. Check server SSH logs: sudo journalctl -u ssh"
            exit 1
          fi

      - name: Deploy Docker Compose File
        run: |
          echo "ğŸ“ Copying Docker Compose file to server..."
          if scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no Docker-Compose.yml root@${{ secrets.IP_MASTER }}:/home/root/docker-compose.yml; then
            echo "âœ… Docker Compose file copied successfully"
          else
            echo "âŒ Failed to copy Docker Compose file"
            exit 1
          fi
          
          echo "ğŸ” Verifying file on remote server..."
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ secrets.IP_MASTER }} 'ls -la /home/root/docker-compose.yml && echo "ğŸ“‹ File verification complete"'

        

      
        

  
        